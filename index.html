<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Super Invader</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Make the canvas fill the entire screen */
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        font-family: "Press Start 2P", cursive;
        color: white;
      }
      canvas {
        display: none; /* Hidden until game starts */
      }

      #asset-cache {
        position: absolute;
        top: -9999px;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }

      #crt-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }
      #crt-overlay::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.4) 0px,
          rgba(0, 0, 0, 0.4) 1px,
          transparent 1px,
          transparent 2px
        );
        opacity: 0.9;
      }
      #crt-overlay::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          ellipse at center,
          rgba(0, 0, 0, 0) 50%,
          rgba(0, 0, 0, 0.85) 100%
        );
        animation: flicker 0.1s infinite;
      }
      @keyframes flicker {
        0% {
          opacity: 0.9;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.9;
        }
      }

      @keyframes scroll-background {
        from {
          background-position: 0 0;
        }
        to {
          background-position: -512px 0;
        }
      }

      .game-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        background-image: url("https://cdn.wallpapersafari.com/63/68/f1g5Ap.png");
        background-size: auto;
        animation: scroll-background 60s linear infinite;
        z-index: 20;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }

      .game-screen h1,
      .game-screen h2 {
        text-shadow: 4px 4px #00ffff;
      }
      .game-screen h1 {
        font-size: 3em;
      }
      .game-screen h2 {
        font-size: 2em;
      }

      .menu-button {
        font-family: "Press Start 2P", cursive;
        font-size: 1.5em;
        padding: 15px 30px;
        background-color: #333;
        color: white;
        border: 2px solid white;
        cursor: pointer;
        margin-top: 20px;
        text-shadow: 2px 2px #000;
      }
      .menu-button:hover {
        background-color: #00ffff;
        color: #000;
      }
      .menu-button:disabled {
        background-color: #222;
        color: #555;
        border-color: #555;
        cursor: not-allowed;
      }

      #ship-select-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .ship-card {
        border: 2px solid #888;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        background: rgba(0, 0, 0, 0.5);
      }
      .ship-card:hover {
        border-color: #00ffff;
        box-shadow: 0 0 15px #00ffff;
        transform: scale(1.05);
      }
      .ship-card img {
        width: 96px;
        height: 96px;
        image-rendering: pixelated;
      }
      .ship-card p {
        margin: 5px 0 0 0;
        font-size: 0.8em;
      }
      .ship-card.locked {
        cursor: not-allowed;
        filter: grayscale(1) brightness(0.5);
      }
      .ship-card.locked:hover {
        border-color: #888;
        box-shadow: none;
        transform: none;
      }

      .modal {
        display: none;
        position: absolute;
        z-index: 25;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: rgba(10, 20, 40, 0.9);
        border: 2px solid #00ffff;
        padding: 20px;
        width: 90%;
        max-width: 600px;
        text-align: center;
      }
      .modal-content input {
        font-family: "Press Start 2P", cursive;
        background: #000;
        border: 1px solid #fff;
        color: #fff;
        padding: 10px;
        font-size: 1em;
        margin: 10px 0;
        width: 80%;
      }

      #leaderboard-list {
        list-style: none;
        padding: 0;
        max-height: 50vh;
        overflow-y: auto;
        text-align: left;
      }
      #leaderboard-list li {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #555;
      }
      #leaderboard-list li span:first-child {
        margin-right: 20px;
      }

      #discovery-panel {
        display: none;
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 800px;
        padding: 15px;
        background: rgba(10, 20, 40, 0.85);
        border: 2px solid #00ffff;
        color: #fff;
        text-align: center;
        z-index: 15;
        box-shadow: 0 0 15px #00ffff;
      }
      #discovery-panel h2 {
        margin-top: 0;
        font-size: 1.2em;
      }
      #discovery-panel p {
        margin: 8px 0;
        font-size: 0.8em;
        line-height: 1.4;
      }
      #discovery-close-prompt {
        margin-top: 10px;
        font-size: 0.7em;
        color: #aaa;
      }
      .rarity-Common {
        color: #ffffff;
      }
      .rarity-Rare {
        color: #55aaff;
        text-shadow: 0 0 5px #55aaff;
      }
      .rarity-Legendary {
        color: #ffd700;
        text-shadow: 0 0 8px #ffd700;
      }
      .rarity-Unique {
        background: linear-gradient(
          90deg,
          #ff0000,
          #ff7f00,
          #ffff00,
          #00ff00,
          #0000ff,
          #4b0082,
          #9400d3
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: rainbow-text 3s linear infinite;
      }
      @keyframes rainbow-text {
        0% {
          background-position: 0% 50%;
        }
        100% {
          background-position: 100% 50%;
        }
      }

      #pirate-warning {
        display: none;
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 2em;
        color: #ff0000;
        text-shadow: 3px 3px #000;
        z-index: 16;
        animation: pulse-warning 1s infinite;
      }
      @keyframes pulse-warning {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      #steal-progress-bar-container {
        display: none;
        position: absolute;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        height: 20px;
        border: 2px solid #ff0000;
        background: #330000;
        z-index: 16;
      }
      #steal-progress-bar {
        width: 0%;
        height: 100%;
        background: #ff0000;
      }

      #touch-controls {
        display: none;
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 12;
        pointer-events: none;
      }
      .touch-button {
        position: absolute;
        bottom: 30px;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.4);
        pointer-events: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        user-select: none;
      }
      .touch-button.active {
        background: rgba(255, 255, 255, 0.5);
      }
      #joystick-base {
        position: absolute;
        left: 40px;
        bottom: 40px;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.4);
        pointer-events: auto;
      }
      #joystick-knob {
        position: absolute;
        left: 30px;
        top: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
      }
      #thrust-button {
        right: 100px;
        bottom: 90px;
      }
      #turbo-button {
        right: 30px;
        bottom: 130px;
      }
      #brake-button {
        right: 30px;
        bottom: 40px;
      }
      #dock-button {
        display: none;
        right: 180px;
        bottom: 40px;
        background: rgba(0, 255, 255, 0.2);
        border-color: rgba(0, 255, 255, 0.4);
      }
      #dock-prompt {
        display: none;
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translateX(-50%);
        color: #00ffff;
        font-size: 1.5em;
        text-shadow: 2px 2px #000;
        z-index: 13;
      }
    </style>
  </head>
  <body>
    <canvas id="gameCanvas"></canvas>
    <div id="crt-overlay"></div>
    <div id="asset-cache"></div>

    <!-- Menu Screens -->
    <div id="main-menu-screen" class="game-screen">
      <h1>Super Invader</h1>
      <div>
        <button id="startButton" class="menu-button" disabled>
          Loading...
        </button>
        <button id="leaderboardButton" class="menu-button">Leaderboard</button>
      </div>
    </div>
    <div id="ship-select-screen" class="game-screen" style="display: none">
      <h2>Choose Your Ship</h2>
      <div id="ship-select-container">
        <div class="ship-card" data-ship="ship1">
          <img src="ship1.png" alt="Vanguard" />
          <p>Vanguard</p>
          <p>Life: 5/5</p>
          <p>Upgrades: 1</p>
        </div>
        <div class="ship-card" data-ship="ship2">
          <img src="ship2.png" alt="Interceptor" />
          <p>Interceptor</p>
          <p>Life: 3/3</p>
          <p>Upgrades: 2</p>
        </div>
        <div class="ship-card locked" data-ship="ship3">
          <img src="ship3.png" alt="???" />
          <p>???</p>
          <p>PREMIUM</p>
          <p>Locked</p>
        </div>
      </div>
    </div>
    <div id="game-over-screen" class="game-screen" style="display: none">
      <h1>Game Over</h1>
      <button id="restartButton" class="menu-button">Main Menu</button>
    </div>

    <!-- In-Game UI -->
    <div id="discovery-panel">
      <h2 id="discovery-name"></h2>
      <p id="discovery-formula"></p>
      <p id="discovery-description"></p>
      <p id="discovery-close-prompt">Press 'E' to close</p>
    </div>
    <div id="pirate-warning">INVASION!</div>
    <div id="steal-progress-bar-container">
      <div id="steal-progress-bar"></div>
    </div>
    <div id="dock-prompt">Press 'E' to Dock</div>

    <!-- Modals -->
    <div id="leaderboard-modal" class="modal">
      <div class="modal-content">
        <h2>Leaderboard</h2>
        <ol id="leaderboard-list"></ol>
        <button id="closeLeaderboardButton" class="menu-button">Close</button>
      </div>
    </div>
    <div id="save-score-modal" class="modal">
      <div class="modal-content">
        <h2>Docked at Station</h2>
        <p>Your current score is <span id="save-score-value">0</span>.</p>
        <input
          type="text"
          id="playerNameInput"
          placeholder="Enter Your Name"
          maxlength="10"
        />
        <button id="saveScoreButton" class="menu-button">Save Score</button>
        <button id="viewLeaderboardFromStationButton" class="menu-button">
          View Leaderboard
        </button>
        <button id="undockButton" class="menu-button">Undock</button>
      </div>
    </div>

    <!-- Touch Controls UI -->
    <div id="touch-controls">
      <div id="joystick-base">
        <div id="joystick-knob"></div>
      </div>
      <div id="thrust-button" class="touch-button">THRUST</div>
      <div id="turbo-button" class="touch-button">TURBO</div>
      <div id="brake-button" class="touch-button">BRAKE</div>
      <div id="dock-button" class="touch-button">DOCK</div>
    </div>

    <script type="module">
      // --- FIREBASE IMPORTS ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        setLogLevel,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- SETUP ---
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const assetCache = document.getElementById("asset-cache");

      // UI Elements
      const mainMenuScreen = document.getElementById("main-menu-screen");
      const shipSelectScreen = document.getElementById("ship-select-screen");
      const gameOverScreen = document.getElementById("game-over-screen");
      const discoveryPanel = document.getElementById("discovery-panel");
      const startButton = document.getElementById("startButton");
      const restartButton = document.getElementById("restartButton");
      const shipCards = document.querySelectorAll(".ship-card");
      const pirateWarning = document.getElementById("pirate-warning");
      const stealBarContainer = document.getElementById(
        "steal-progress-bar-container"
      );
      const stealBar = document.getElementById("steal-progress-bar");
      const dockPrompt = document.getElementById("dock-prompt");
      const dockButton = document.getElementById("dock-button");
      const leaderboardModal = document.getElementById("leaderboard-modal");
      const saveScoreModal = document.getElementById("save-score-modal");
      const leaderboardButton = document.getElementById("leaderboardButton");
      const closeLeaderboardButton = document.getElementById(
        "closeLeaderboardButton"
      );
      const undockButton = document.getElementById("undockButton");
      const viewLeaderboardFromStationButton = document.getElementById(
        "viewLeaderboardFromStationButton"
      );
      const saveScoreButton = document.getElementById("saveScoreButton");
      const touchControls = document.getElementById("touch-controls");

      // --- FIREBASE SETUP ---
      let db, auth;
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "super-invader-standalone";

      async function initFirebase() {
        try {
          const firebaseConfig = {
            apiKey: "AIzaSyCFWrErGbsxkNwVMhJMyDYkpY1FO3B33Yk",
            authDomain: "superinvader-af884.firebaseapp.com",
            projectId: "superinvader-af884",
            storageBucket: "superinvader-af884.appspot.com",
            messagingSenderId: "196708489729",
            appId: "1:196708489729:web:2990c863c006cccf2e7e00",
            measurementId: "G-1VFFXP0X67",
          };

          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
          setLogLevel("debug");
          await signInAnonymously(auth);
          console.log(
            "Firebase initialized and user signed in.",
            auth.currentUser?.uid
          );
          setupLeaderboardListener();
        } catch (error) {
          console.error("Firebase initialization failed:", error);
        }
      }

      // --- LEADERBOARD LOGIC ---
      let leaderboardData = [];
      function setupLeaderboardListener() {
        if (!db) return;
        const leaderboardPath = `artifacts/${appId}/public/data/leaderboard`;
        const leaderboardCol = collection(db, leaderboardPath);
        const q = query(leaderboardCol);

        onSnapshot(
          q,
          (snapshot) => {
            leaderboardData = [];
            snapshot.forEach((doc) => {
              leaderboardData.push(doc.data());
            });
            leaderboardData.sort((a, b) => b.score - a.score);
            updateLeaderboardUI();
          },
          (error) => {
            console.error("Error listening to leaderboard:", error);
          }
        );
      }

      function updateLeaderboardUI() {
        const list = document.getElementById("leaderboard-list");
        list.innerHTML = "";
        leaderboardData.slice(0, 20).forEach((entry, index) => {
          const li = document.createElement("li");
          li.innerHTML = `<span>${index + 1}. ${entry.name}</span><span>${
            entry.score
          }</span>`;
          list.appendChild(li);
        });
      }

      async function saveScore(name, scoreToSave) {
        if (!name || scoreToSave <= 0 || !db) return;
        try {
          const leaderboardPath = `artifacts/${appId}/public/data/leaderboard`;
          const leaderboardCol = collection(db, leaderboardPath);
          await addDoc(leaderboardCol, {
            name: name,
            score: scoreToSave,
            timestamp: new Date(),
          });
          console.log("Score saved successfully!");
          score = 0;
        } catch (error) {
          console.error("Error saving score: ", error);
        }
      }

      const mineralsDB = [
        {
          name: "Quartz",
          formula: "SiO₂",
          description: "A hard, crystalline mineral composed of silica.",
          rarity: "Common",
          score: 10,
        },
        {
          name: "Iron",
          formula: "Fe",
          description:
            "The most common element on Earth by mass, forged in the cores of stars.",
          rarity: "Common",
          score: 25,
        },
        {
          name: "Gold",
          formula: "Au",
          description:
            "A precious metal forged in the collision of neutron stars.",
          rarity: "Rare",
          score: 50,
        },
        {
          name: "Diamond",
          formula: "C",
          description:
            "A metastable allotrope of carbon, formed under immense pressure deep within planetary mantles.",
          rarity: "Rare",
          score: 80,
        },
        {
          name: "Iridium",
          formula: "Ir",
          description:
            "A very hard, brittle, silvery-white transition metal. Evidence of extraterrestrial impacts.",
          rarity: "Rare",
          score: 100,
        },
        {
          name: "Tanzanite",
          formula: "Ca₂Al₃(SiO₄)(Si₂O₇)O(OH)",
          description:
            "Exhibits strong trichroism, appearing alternately blue, violet and burgundy.",
          rarity: "Legendary",
          score: 225,
        },
        {
          name: "Painite",
          formula: "CaZrAl₉O₁₅(BO₃)",
          description:
            "Once held the Guinness World Record for the rarest gemstone.",
          rarity: "Legendary",
          score: 250,
        },
        {
          name: "Jarosite",
          formula: "KFe₃(SO₄)₂(OH)₆",
          description:
            "Its discovery on Mars provided strong evidence of past water activity.",
          rarity: "Unique",
          score: 1000,
        },
        {
          name: "Helium-3",
          formula: "³He",
          description:
            "A light, non-radioactive isotope of helium, thought to be abundant on the Moon.",
          rarity: "Unique",
          score: 1500,
        },
        {
          name: "Oganesson",
          formula: "Og",
          description:
            "The heaviest element ever created, with an extremely short half-life.",
          rarity: "Unique",
          score: 5000,
        },
      ];

      const shipImages = {
        ship1: new Image(),
        ship2: new Image(),
        ship3: new Image(),
      };
      const pirateImage = new Image();
      const stationImage = new Image();
      const superInvaderImages = [];
      const asteroidImages = [];
      const planetSpriteSheets = [];
      const PLANET_FRAME_COUNT = 24;
      const planetSpriteSheetSources = [
        "Planet_Sprite_Sheets/1.png",
        "Planet_Sprite_Sheets/2.png",
        "Planet_Sprite_Sheets/3.png",
        "Planet_Sprite_Sheets/4.png",
        "Planet_Sprite_Sheets/5.png",
        "Planet_Sprite_Sheets/6.png",
        "Planet_Sprite_Sheets/7.png",
        "Planet_Sprite_Sheets/8.png",
      ];
      const asteroidImageSources = [
        "Asteroids/1.png",
        "Asteroids/2.png",
        "Asteroids/3.png",
        "Asteroids/4.png",
        "Asteroids/5.png",
        "Asteroids/6.png",
        "Asteroids/7.png",
        "Asteroids/8.png",
        "Asteroids/9.png",
        "Asteroids/10.png",
        "Asteroids/11.png",
        "Asteroids/12.png",
        "Asteroids/13.png",
        "Asteroids/14.png",
        "Asteroids/15.png",
      ];
      const superInvaderImageSources = [
        "Superinvaders/inv1.png",
        "Superinvaders/inv2.png",
        "Superinvaders/inv3.png",
        "Superinvaders/inv4.png",
        "Superinvaders/inv5.png",
        "Superinvaders/inv6.png",
        "Superinvaders/inv7.png",
        "Superinvaders/inv8.png",
        "Superinvaders/inv9.png",
      ];

      const radarAudio = new Audio("Radar.mp3");
      const loopAudio = new Audio("loop.mp3");
      const alarmAudio = new Audio("alarm.mp3");
      const supAudio = new Audio("Sup.mp3"); // NEW

      let assetsToLoad =
        planetSpriteSheetSources.length +
        asteroidImageSources.length +
        Object.keys(shipImages).length +
        2 +
        superInvaderImageSources.length;
      let assetsLoaded = 0;

      function assetLoaded() {
        assetsLoaded++;
        if (assetsLoaded === assetsToLoad) {
          startButton.disabled = false;
          startButton.textContent = "Start";
        }
      }

      let gameState = "menu";
      let score = 0;
      let nearestPlanetInfo = {
        name: "",
        distance: Infinity,
        discovered: false,
      };
      let isRadarPlaying = false;
      let isPanelOpen = false;
      let animationFrameId;
      let pendingInvasionRarity = null;
      let stealProgress = 0;
      let station = null;
      let nearestStationInfo = { distance: Infinity };

      const player = {
        x: 0,
        y: 0,
        radius: 15,
        angle: 0,
        rotationSpeed: 0.1,
        speed: 0,
        acceleration: 0.1,
        turboAcceleration: 0.5,
        friction: 0.98,
        image: null,
        velX: 0,
        velY: 0,
      };
      const REPULSION_RANGE = 150;
      const REPULSION_STRENGTH = 0.5;

      let pirates = [];
      const PIRATE_STEAL_RANGE = 300;
      const PIRATE_INVASION_DURATION = 20 * 60;
      const PIRATE_BASE_MAX_SPEED = 7.0;
      const PIRATE_BASE_ACCELERATION = 0.1;
      const PIRATE_TURBO_MAX_SPEED = 9.5;
      const PIRATE_TURBO_ACCELERATION = 0.15;

      let superInvaders = [];

      const camera = { x: player.x, y: player.y };
      let stars = [];
      const starLayers = [
        { speed: 0.2, radius: 0.5, countMultiplier: 0.5 },
        { speed: 0.4, radius: 1.0, countMultiplier: 0.35 },
        { speed: 0.6, radius: 1.2, countMultiplier: 0.15 },
      ];
      let planets = [];
      let asteroids = [];
      const SECTOR_SIZE = 5000;
      let generatedSectors = new Set();

      function mulberry32(a) {
        return function () {
          var t = (a += 0x6d2b79f5);
          t = Math.imul(t ^ (t >>> 15), t | 1);
          t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
          return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
      }

      function generateEntitiesForSector(sectorX, sectorY) {
        const sectorKey = `${sectorX},${sectorY}`;
        if (generatedSectors.has(sectorKey)) return;
        generatedSectors.add(sectorKey);

        const seed = sectorX * 18397 + sectorY * 23117;
        const rng = mulberry32(seed);

        let hasPlanet = false;
        if (rng() < 0.25) {
          hasPlanet = true;
          const pScale = 3.0,
            pSheet =
              planetSpriteSheets[Math.floor(rng() * planetSpriteSheets.length)],
            frameWidth = pSheet.width / PLANET_FRAME_COUNT,
            w = frameWidth * pScale,
            h = pSheet.height * pScale,
            mineral = mineralsDB[Math.floor(rng() * mineralsDB.length)];
          planets.push({
            x: sectorX * SECTOR_SIZE + rng() * SECTOR_SIZE,
            y: sectorY * SECTOR_SIZE + rng() * SECTOR_SIZE,
            radius: w / 2,
            sheet: pSheet,
            discovered: false,
            width: w,
            height: h,
            frameCount: PLANET_FRAME_COUNT,
            frameWidth: frameWidth,
            currentFrame: 0,
            animationTimer: 0,
            animationSpeed: 20 + rng() * 15,
            mineral: mineral,
          });
        }

        if (rng() < 0.4) {
          const numAsteroids = Math.floor(rng() * 25) + 10;
          for (let i = 0; i < numAsteroids; i++) {
            const aImg =
              asteroidImages[Math.floor(rng() * asteroidImages.length)];
            asteroids.push({
              x: sectorX * SECTOR_SIZE + rng() * SECTOR_SIZE,
              y: sectorY * SECTOR_SIZE + rng() * SECTOR_SIZE,
              image: aImg,
              radius: aImg.width / 2,
              angle: rng() * Math.PI * 2,
              rotationSpeed: (rng() - 0.5) * 0.02,
              speedX: (rng() - 0.5) * 2,
              speedY: (rng() - 0.5) * 2,
            });
          }
        }

        if (!hasPlanet && !station && rng() < 0.03) {
          station = {
            x: sectorX * SECTOR_SIZE + rng() * SECTOR_SIZE,
            y: sectorY * SECTOR_SIZE + rng() * SECTOR_SIZE,
            radius: 100,
            image: stationImage,
          };
        }
      }

      function spawnPirate() {
        const spawnAngle = Math.random() * Math.PI * 2;
        const spawnDist = Math.max(canvas.width, canvas.height);
        pirates.push({
          x: player.x + Math.cos(spawnAngle) * spawnDist,
          y: player.y + Math.sin(spawnAngle) * spawnDist,
          radius: 20,
          angle: 0,
          rotationSpeed: 0.07,
          speed: 0,
          state: "chasing",
          timer: PIRATE_INVASION_DURATION,
        });
        alarmAudio.play().catch((e) => console.warn("Alarm could not play"));
        pirateWarning.style.display = "block";
      }

      function updatePirates() {
        if (pirates.length === 0) return;

        let isPlayerBeingStolenFrom = false;

        for (let i = pirates.length - 1; i >= 0; i--) {
          const pirate = pirates[i];
          pirate.timer--;

          if (pirate.state === "chasing") {
            if (pirate.timer <= 0) {
              pirate.state = "escaping";
            }

            const predictionTime = 30 + player.speed * 2;
            const predictedPlayerX = player.x + player.velX * predictionTime;
            const predictedPlayerY = player.y + player.velY * predictionTime;

            const dx = predictedPlayerX - pirate.x;
            const dy = predictedPlayerY - pirate.y;
            const targetAngle = Math.atan2(dy, dx);

            let angleDiff = targetAngle - pirate.angle;
            while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
            while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
            pirate.angle += angleDiff * pirate.rotationSpeed;
            pirate.angle %= Math.PI * 2;

            const targetMaxSpeed = keys.Shift
              ? PIRATE_TURBO_MAX_SPEED
              : PIRATE_BASE_MAX_SPEED;
            const targetAcceleration = keys.Shift
              ? PIRATE_TURBO_ACCELERATION
              : PIRATE_BASE_ACCELERATION;
            pirate.speed = Math.min(
              targetMaxSpeed,
              pirate.speed + targetAcceleration
            );

            const stealDist = Math.sqrt(
              Math.pow(player.x - pirate.x, 2) +
                Math.pow(player.y - pirate.y, 2)
            );
            if (stealDist < PIRATE_STEAL_RANGE) {
              isPlayerBeingStolenFrom = true;
            }
          } else if (pirate.state === "escaping") {
            pirate.speed += PIRATE_BASE_ACCELERATION;
            if (pirate.timer < -300) {
              pirates.splice(i, 1);
            }
          }

          if (pirate) {
            pirate.x += pirate.speed * Math.cos(pirate.angle);
            pirate.y += pirate.speed * Math.sin(pirate.angle);
          }
        }

        if (isPlayerBeingStolenFrom) {
          stealProgress = Math.min(100, stealProgress + 0.5);
          stealBarContainer.style.display = "block";
          stealBar.style.width = `${stealProgress}%`;
        } else {
          stealProgress = Math.max(0, stealProgress - 0.1);
          if (stealProgress > 0) {
            stealBar.style.width = `${stealProgress}%`;
          } else {
            stealBarContainer.style.display = "none";
          }
        }

        if (stealProgress >= 100) {
          score = 0;
          pirates.forEach((p) => (p.state = "escaping"));
        }

        if (pirates.length === 0) {
          pirateWarning.style.display = "none";
          stealBarContainer.style.display = "none";
        }
      }

      function spawnSuperInvader() {
        if (superInvaders.length > 0) return;

        supAudio
          .play()
          .catch((e) => console.warn("Super invader sound failed to play")); // NEW

        const edge = Math.floor(Math.random() * 4);
        let startX, startY, endX, endY;
        const buffer = 100;

        if (edge === 0) {
          startX = Math.random() * canvas.width;
          startY = -buffer;
          endX = Math.random() * canvas.width;
          endY = canvas.height + buffer;
        } else if (edge === 1) {
          startX = canvas.width + buffer;
          startY = Math.random() * canvas.height;
          endX = -buffer;
          endY = Math.random() * canvas.height;
        } else if (edge === 2) {
          startX = Math.random() * canvas.width;
          startY = canvas.height + buffer;
          endX = Math.random() * canvas.width;
          endY = -buffer;
        } else {
          startX = -buffer;
          startY = Math.random() * canvas.height;
          endX = canvas.width + buffer;
          endY = Math.random() * canvas.height;
        }

        const angle = Math.atan2(endY - startY, endX - startX);
        const namePrefixes = ["X", "Z", "V", "R", "T"];
        const name = `${
          namePrefixes[Math.floor(Math.random() * namePrefixes.length)]
        }${Math.floor(Math.random() * 9) + 1} Super Invader`;

        superInvaders.push({
          x: startX + camera.x,
          y: startY + camera.y,
          angle: angle,
          speed: (15 + Math.random() * 5) * 1.5, // UPDATED
          image:
            superInvaderImages[
              Math.floor(Math.random() * superInvaderImages.length)
            ],
          name: name,
        });
      }

      function updateSuperInvaders() {
        for (let i = superInvaders.length - 1; i >= 0; i--) {
          const invader = superInvaders[i];
          invader.x += invader.speed * Math.cos(invader.angle);
          invader.y += invader.speed * Math.sin(invader.angle);

          const screenX = invader.x - camera.x;
          const screenY = invader.y - camera.y;
          const buffer = 200;

          if (
            screenX < -buffer ||
            screenX > canvas.width + buffer ||
            screenY < -buffer ||
            screenY > canvas.height + buffer
          ) {
            superInvaders.splice(i, 1);
          }
        }
      }

      const keys = {
        ArrowUp: false,
        ArrowLeft: false,
        ArrowRight: false,
        Shift: false,
        " ": false,
        e: false,
      };
      window.addEventListener("keydown", (e) => {
        if (keys.hasOwnProperty(e.key)) {
          e.preventDefault();
          keys[e.key] = true;
        }
        if (e.key === "e" || e.key === "E") {
          if (isPanelOpen) {
            toggleDiscoveryPanel(false);
          } else if (isNearStation()) {
            dockAtStation();
          }
        }
      });
      window.addEventListener("keyup", (e) => {
        if (keys.hasOwnProperty(e.key)) {
          keys[e.key] = false;
        }
      });

      startButton.addEventListener("click", () => {
        loopAudio.play().catch(() => {});
        loopAudio.pause();
        alarmAudio.play().catch(() => {});
        alarmAudio.pause();
        radarAudio.play().catch(() => {});
        radarAudio.pause();
        supAudio.play().catch(() => {});
        supAudio.pause();

        mainMenuScreen.style.display = "none";
        shipSelectScreen.style.display = "flex";
        gameState = "shipSelect";
      });
      restartButton.addEventListener("click", () => {
        gameOverScreen.style.display = "none";
        mainMenuScreen.style.display = "flex";
        gameState = "menu";
        loopAudio.pause();
        loopAudio.currentTime = 0;
      });

      shipCards.forEach((card) => {
        if (card.classList.contains("locked")) return;
        card.addEventListener("click", () => {
          const shipId = card.getAttribute("data-ship");
          startGame(shipId);
        });
      });

      discoveryPanel.addEventListener("click", () =>
        toggleDiscoveryPanel(false)
      );

      leaderboardButton.addEventListener(
        "click",
        () => (leaderboardModal.style.display = "flex")
      );
      closeLeaderboardButton.addEventListener(
        "click",
        () => (leaderboardModal.style.display = "none")
      );
      undockButton.addEventListener("click", undock);
      viewLeaderboardFromStationButton.addEventListener(
        "click",
        () => (leaderboardModal.style.display = "flex")
      );
      saveScoreButton.addEventListener("click", () => {
        const playerName = document
          .getElementById("playerNameInput")
          .value.trim();
        if (playerName) {
          saveScore(playerName, score);
          document.getElementById("playerNameInput").value = "";
          undock();
        } else {
          document.getElementById("playerNameInput").style.borderColor = "red";
        }
      });
      dockButton.addEventListener("click", dockAtStation);

      function startGame(shipId) {
        player.image = shipImages[shipId];
        shipSelectScreen.style.display = "none";
        canvas.style.display = "block";

        resetGameData();
        gameState = "playing";
        if (animationFrameId) cancelAnimationFrame(animationFrameId);

        loopAudio.loop = true;
        loopAudio.volume = 0.4;
        loopAudio
          .play()
          .catch((e) => console.warn("Background audio auto-play failed."));

        gameLoop();
      }

      function resetGameData() {
        player.x = 0;
        player.y = 0;
        player.speed = 0;
        player.angle = 0;
        player.velX = 0;
        player.velY = 0;
        camera.x = 0;
        camera.y = 0;
        planets = [];
        asteroids = [];
        superInvaders = [];
        generatedSectors.clear();
        score = 0;
        pirates = [];
        station = null;
        stealProgress = 0;
        pirateWarning.style.display = "none";
        stealBarContainer.style.display = "none";
        toggleDiscoveryPanel(false);
      }

      function toggleDiscoveryPanel(show, mineral = null) {
        if (show && mineral) {
          isPanelOpen = true;
          discoveryPanel.style.display = "block";
          document.getElementById(
            "discovery-name"
          ).textContent = `[${mineral.rarity}] ${mineral.name}`;
          document.getElementById(
            "discovery-name"
          ).className = `rarity-${mineral.rarity}`;
          document.getElementById(
            "discovery-formula"
          ).textContent = `Formula: ${mineral.formula}`;
          document.getElementById("discovery-description").textContent =
            mineral.description;
        } else {
          if (isPanelOpen) {
            isPanelOpen = false;
            discoveryPanel.style.display = "none";
            triggerPendingInvasion();
          }
        }
      }

      function triggerPendingInvasion() {
        if (!pendingInvasionRarity) return;

        const rarity = pendingInvasionRarity;
        pendingInvasionRarity = null;
        const rarityRoll = Math.random();

        if (rarity === "Unique") {
          spawnPirate();
          spawnPirate();
        } else if (
          (rarity === "Legendary" && rarityRoll < 0.75) ||
          (rarity === "Rare" && rarityRoll < 0.25)
        ) {
          spawnPirate();
        }
      }

      const DOCKING_RANGE = 200;

      function isNearStation() {
        return station && nearestStationInfo.distance < DOCKING_RANGE;
      }

      function dockAtStation() {
        if (!isNearStation()) return;
        gameState = "docked";
        document.getElementById("save-score-value").textContent = score;
        saveScoreModal.style.display = "flex";
      }

      function undock() {
        saveScoreModal.style.display = "none";
        gameState = "playing";
      }

      function generateStars() {
        stars = [];
        const base = (canvas.width * canvas.height) / 3000;
        starLayers.forEach((l) => {
          for (let i = 0; i < Math.floor(base * l.countMultiplier); i++)
            stars.push({
              x: Math.random() * canvas.width,
              y: Math.random() * canvas.height,
              radius: l.radius,
              speed: l.speed,
            });
        });
      }
      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        generateStars();
      }
      window.addEventListener("resize", resizeCanvas);

      function gameLoop() {
        if (gameState === "docked") {
          requestAnimationFrame(gameLoop);
          return;
        }

        if (gameState === "playing" && !isPanelOpen) {
          const accel = keys.Shift
            ? player.turboAcceleration
            : player.acceleration;
          if (keys.ArrowLeft) player.angle -= player.rotationSpeed;
          if (keys.ArrowRight) player.angle += player.rotationSpeed;
          if (keys.ArrowUp) player.speed += accel;
          if (keys[" "]) player.speed *= 0.92;
          player.speed *= player.friction;
          player.velX = player.speed * Math.cos(player.angle);
          player.velY = player.speed * Math.sin(player.angle);
          player.x += player.velX;
          player.y += player.velY;
        }
        if (gameState === "playing") {
          camera.x = player.x;
          camera.y = player.y;

          const sX = Math.floor(player.x / SECTOR_SIZE),
            sY = Math.floor(player.y / SECTOR_SIZE);
          for (let y = -1; y <= 1; y++) {
            for (let x = -1; x <= 1; x++)
              generateEntitiesForSector(sX + x, sY + y);
          }

          updatePirates();
          updateSuperInvaders();

          if (Math.random() < 0.001) {
            spawnSuperInvader();
          }

          asteroids.forEach((a) => {
            a.x += a.speedX;
            a.y += a.speedY;
            a.angle += a.rotationSpeed;
            const dx = a.x - player.x,
              dy = a.y - player.y,
              dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < REPULSION_RANGE) {
              const forceAngle = Math.atan2(dy, dx),
                forceMagnitude =
                  REPULSION_STRENGTH * (1 - dist / REPULSION_RANGE);
              a.speedX += Math.cos(forceAngle) * forceMagnitude;
              a.speedY += Math.sin(forceAngle) * forceMagnitude;
            }
          });

          planets.forEach((p) => {
            p.animationTimer++;
            if (p.animationTimer > p.animationSpeed) {
              p.animationTimer = 0;
              p.currentFrame = (p.currentFrame + 1) % p.frameCount;
            }
          });

          if (station) {
            const dx = player.x - station.x;
            const dy = player.y - station.y;
            nearestStationInfo.distance = Math.sqrt(dx * dx + dy * dy);

            if (isNearStation()) {
              dockPrompt.style.display = "block";
              dockButton.style.display = "flex";
            } else {
              dockPrompt.style.display = "none";
              dockButton.style.display = "none";
            }
          } else {
            nearestStationInfo.distance = Infinity;
            dockPrompt.style.display = "none";
            dockButton.style.display = "none";
          }
        }

        ctx.save();
        let invaderShake = superInvaders.length > 0;
        if (
          (gameState === "playing" && keys.Shift && player.speed > 5) ||
          invaderShake
        ) {
          const shake = invaderShake ? 2 : player.speed * 0.2;
          ctx.translate(
            (Math.random() - 0.5) * shake,
            (Math.random() - 0.5) * shake
          );
        }
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        stars.forEach((s) => {
          const pX =
            (((s.x - camera.x * s.speed) % canvas.width) + canvas.width) %
            canvas.width;
          const pY =
            (((s.y - camera.y * s.speed) % canvas.height) + canvas.height) %
            canvas.height;
          if (keys.Shift && player.speed > 2) {
            const len = player.speed * s.speed * 0.6,
              sX = pX - Math.cos(player.angle) * len,
              sY = pY - Math.sin(player.angle) * len;
            ctx.beginPath();
            ctx.moveTo(sX, sY);
            ctx.lineTo(pX, pY);
            ctx.strokeStyle = "#FFF";
            ctx.lineWidth = s.radius * 2;
            ctx.stroke();
          } else {
            ctx.beginPath();
            ctx.arc(pX, pY, s.radius, 0, Math.PI * 2);
            ctx.fillStyle = "#FFF";
            ctx.fill();
          }
        });

        let minDistance = Infinity;
        let currentNearestPlanet = null;
        planets.forEach((p) => {
          const psX = p.x - camera.x + canvas.width / 2,
            psY = p.y - camera.y + canvas.height / 2;
          if (
            psX + p.radius > 0 &&
            psX - p.radius < canvas.width &&
            psY + p.radius > 0 &&
            psY - p.radius < canvas.height
          ) {
            const sourceX = p.currentFrame * p.frameWidth;
            ctx.drawImage(
              p.sheet,
              sourceX,
              0,
              p.frameWidth,
              p.sheet.height,
              psX - p.radius,
              psY - p.radius,
              p.width,
              p.height
            );
          }
          if (gameState === "playing") {
            const dx = player.x - p.x,
              dy = player.y - p.y,
              dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < minDistance) {
              minDistance = dist;
              currentNearestPlanet = p;
            }
            if (dist < p.radius + 100 && !p.discovered) {
              p.discovered = true;
              score += p.mineral.score;
              toggleDiscoveryPanel(true, p.mineral);
              pendingInvasionRarity = p.mineral.rarity;
            }
          }
        });
        asteroids.forEach((a) => {
          const asX = a.x - camera.x + canvas.width / 2,
            asY = a.y - camera.y + canvas.height / 2;
          if (
            asX + a.radius > 0 &&
            asX - a.radius < canvas.width &&
            asY + a.radius > 0 &&
            asY - a.radius < canvas.height
          ) {
            ctx.save();
            ctx.translate(asX, asY);
            ctx.rotate(a.angle);
            ctx.drawImage(
              a.image,
              -a.radius,
              -a.radius,
              a.radius * 2,
              a.radius * 2
            );
            ctx.restore();
          }
        });

        if (station) {
          const sX = station.x - camera.x + canvas.width / 2;
          const sY = station.y - camera.y + canvas.height / 2;
          if (
            sX + station.radius > 0 &&
            sX - station.radius < canvas.width &&
            sY + station.radius > 0 &&
            sY - station.radius < canvas.height
          ) {
            ctx.drawImage(
              station.image,
              sX - station.radius,
              sY - station.radius,
              station.radius * 2,
              station.radius * 2
            );
          }
        }

        pirates.forEach((pirate) => {
          const pScreenX = pirate.x - camera.x + canvas.width / 2;
          const pScreenY = pirate.y - camera.y + canvas.height / 2;

          if (pirate.state === "chasing") {
            ctx.beginPath();
            ctx.arc(pScreenX, pScreenY, PIRATE_STEAL_RANGE, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(255, 0, 0, 0.1)";
            ctx.strokeStyle = "rgba(255, 0, 0, 0.5)";
            ctx.lineWidth = 2;
            ctx.fill();
            ctx.stroke();
          }

          ctx.save();
          ctx.translate(pScreenX, pScreenY);
          ctx.rotate(pirate.angle + Math.PI / 2);
          ctx.drawImage(
            pirateImage,
            -pirateImage.width / 2,
            -pirateImage.height / 2
          );
          ctx.restore();
        });

        superInvaders.forEach((invader) => {
          const iScreenX = invader.x - camera.x;
          const iScreenY = invader.y - camera.y;

          ctx.save();
          ctx.translate(iScreenX, iScreenY);
          ctx.rotate(invader.angle + Math.PI / 2);
          ctx.drawImage(
            invader.image,
            -invader.image.width / 2,
            -invader.image.height / 2
          );
          ctx.restore();

          ctx.font = '12px "Press Start 2P"';
          ctx.textAlign = "center";
          ctx.shadowColor = "#00ffff";
          ctx.shadowBlur = 10;
          ctx.fillStyle = "#00ffff";
          ctx.fillText(invader.name, iScreenX, iScreenY - 40);
          ctx.shadowBlur = 0;
        });

        if (currentNearestPlanet) {
          nearestPlanetInfo = {
            name: currentNearestPlanet.discovered
              ? currentNearestPlanet.mineral.name
              : "Unknown Planet",
            distance: minDistance,
            discovered: currentNearestPlanet.discovered,
          };
        }

        const RADAR_RANGE = 2000;
        if (
          gameState === "playing" &&
          !isPanelOpen &&
          currentNearestPlanet &&
          !currentNearestPlanet.discovered &&
          minDistance < RADAR_RANGE
        ) {
          if (!isRadarPlaying) {
            radarAudio.loop = true;
            radarAudio
              .play()
              .catch((e) => console.warn("Audio policy warning"));
            isRadarPlaying = true;
          }
        } else {
          if (isRadarPlaying) {
            radarAudio.pause();
            radarAudio.currentTime = 0;
            isRadarPlaying = false;
          }
        }

        if (gameState === "playing" && player.image) {
          ctx.save();
          ctx.translate(canvas.width / 2, canvas.height / 2);
          ctx.rotate(player.angle + Math.PI / 2);
          ctx.drawImage(
            player.image,
            -player.image.width / 2,
            -player.image.height / 2
          );
          ctx.restore();
        }

        if (gameState === "playing") {
          ctx.font = '16px "Press Start 2P"';
          ctx.fillStyle = "white";
          ctx.textAlign = "left";
          ctx.fillText(`Score: ${score}`, 10, 30);
          if (nearestPlanetInfo.name) {
            ctx.fillStyle = nearestPlanetInfo.discovered
              ? "lightgreen"
              : "white";
            ctx.fillText(
              `${nearestPlanetInfo.name} - ${Math.round(
                nearestPlanetInfo.distance
              )}`,
              10,
              60
            );
          }
          if (station) {
            ctx.fillStyle = "#00ffff";
            ctx.fillText(
              `Station - ${Math.round(nearestStationInfo.distance)}`,
              10,
              90
            );
          }
        }

        ctx.restore();
        animationFrameId = requestAnimationFrame(gameLoop);
      }

      function setupTouchControls() {
        const isTouch =
          "ontouchstart" in window || navigator.maxTouchPoints > 0;
        if (!isTouch) return;

        touchControls.style.display = "block";

        const joystickBase = document.getElementById("joystick-base");
        const joystickKnob = document.getElementById("joystick-knob");
        const thrustButton = document.getElementById("thrust-button");
        const turboButton = document.getElementById("turbo-button");
        const brakeButton = document.getElementById("brake-button");

        let joyStickActive = false;
        let joyStickId = null;

        joystickBase.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
            if (joyStickActive) return;
            joyStickActive = true;
            joyStickId = e.changedTouches[0].identifier;
          },
          { passive: false }
        );

        window.addEventListener(
          "touchmove",
          (e) => {
            if (!joyStickActive) return;
            e.preventDefault();
            for (let touch of e.changedTouches) {
              if (touch.identifier === joyStickId) {
                const rect = joystickBase.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const dx = touch.clientX - centerX;

                const threshold = rect.width * 0.2;
                if (dx < -threshold) {
                  keys.ArrowLeft = true;
                  keys.ArrowRight = false;
                } else if (dx > threshold) {
                  keys.ArrowLeft = false;
                  keys.ArrowRight = true;
                } else {
                  keys.ArrowLeft = false;
                  keys.ArrowRight = false;
                }

                const clampedX = Math.max(
                  -rect.width / 2,
                  Math.min(rect.width / 2, dx)
                );
                joystickKnob.style.transform = `translateX(${clampedX}px)`;
              }
            }
          },
          { passive: false }
        );

        window.addEventListener("touchend", (e) => {
          for (let touch of e.changedTouches) {
            if (touch.identifier === joyStickId) {
              joyStickActive = false;
              joyStickId = null;
              keys.ArrowLeft = false;
              keys.ArrowRight = false;
              joystickKnob.style.transform = `translateX(0px)`;
            }
          }
        });

        const setupButton = (element, key) => {
          element.addEventListener(
            "touchstart",
            (e) => {
              e.preventDefault();
              keys[key] = true;
              element.classList.add("active");
            },
            { passive: false }
          );
          element.addEventListener("touchend", (e) => {
            e.preventDefault();
            keys[key] = false;
            element.classList.remove("active");
          });
        };

        setupButton(thrustButton, "ArrowUp");
        setupButton(turboButton, "Shift");
        setupButton(brakeButton, " ");
      }

      function loadAllAssets() {
        resizeCanvas();

        const setupImageLoader = (img, src) => {
          img.onload = assetLoaded;
          img.onerror = () => {
            console.error(`Failed to load asset: ${src}`);
          };
          img.src = src;
          assetCache.appendChild(img);
        };

        setupImageLoader(shipImages.ship1, "ship1.png");
        setupImageLoader(shipImages.ship2, "ship2.png");
        setupImageLoader(shipImages.ship3, "ship3.png");
        setupImageLoader(pirateImage, "Pirate.png");
        setupImageLoader(stationImage, "Station.png");

        asteroidImageSources.forEach((src) => {
          const i = new Image();
          asteroidImages.push(i);
          setupImageLoader(i, src);
        });

        planetSpriteSheetSources.forEach((src) => {
          const i = new Image();
          planetSpriteSheets.push(i);
          setupImageLoader(i, src);
        });

        superInvaderImageSources.forEach((src) => {
          const i = new Image();
          superInvaderImages.push(i);
          setupImageLoader(i, src);
        });

        setupTouchControls();
      }

      initFirebase();
      loadAllAssets();
    </script>
  </body>
</html>
