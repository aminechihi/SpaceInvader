<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Super Invader</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Make the canvas fill the entire screen */
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        font-family: "Press Start 2P", cursive;
        color: white;
      }
      canvas {
        display: none; /* Hidden until game starts */
      }

      #asset-cache {
        position: absolute;
        top: -9999px;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }

      #crt-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }
      #crt-overlay::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.4) 0px,
          rgba(0, 0, 0, 0.4) 1px,
          transparent 1px,
          transparent 2px
        );
        opacity: 0.9;
      }
      #crt-overlay::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          ellipse at center,
          rgba(0, 0, 0, 0) 50%,
          rgba(0, 0, 0, 0.85) 100%
        );
        animation: flicker 0.1s infinite;
      }
      @keyframes flicker {
        0% {
          opacity: 0.9;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.9;
        }
      }

      @keyframes scroll-background {
        from {
          background-position: 0 0;
        }
        to {
          background-position: -512px 0;
        }
      }

      .game-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        background-image: url("https://cdn.wallpapersafari.com/63/68/f1g5Ap.png");
        background-size: auto;
        animation: scroll-background 60s linear infinite;
        z-index: 20;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }

      .game-screen h1,
      .game-screen h2 {
        text-shadow: 4px 4px #00ffff;
      }
      .game-screen h1 {
        font-size: 3em;
      }
      .game-screen h2 {
        font-size: 2em;
      }

      .menu-button {
        font-family: "Press Start 2P", cursive;
        font-size: 1.5em;
        padding: 15px 30px;
        background-color: #333;
        color: white;
        border: 2px solid white;
        cursor: pointer;
        margin-top: 20px;
        text-shadow: 2px 2px #000;
      }
      .menu-button:hover {
        background-color: #00ffff;
        color: #000;
      }
      .menu-button:disabled {
        background-color: #222;
        color: #555;
        border-color: #555;
        cursor: not-allowed;
      }

      #ship-select-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .ship-card {
        border: 2px solid #888;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        background: rgba(0, 0, 0, 0.5);
      }
      .ship-card:hover {
        border-color: #00ffff;
        box-shadow: 0 0 15px #00ffff;
        transform: scale(1.05);
      }
      .ship-card img {
        width: 96px;
        height: 96px;
        image-rendering: pixelated;
      }
      .ship-card p {
        margin: 5px 0 0 0;
        font-size: 0.8em;
      }
      .ship-card.locked {
        cursor: not-allowed;
        filter: grayscale(1) brightness(0.5);
      }
      .ship-card.locked:hover {
        border-color: #888;
        box-shadow: none;
        transform: none;
      }

      .modal {
        display: none;
        position: absolute;
        z-index: 25;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: rgba(10, 20, 40, 0.9);
        border: 2px solid #00ffff;
        padding: 20px;
        width: 90%;
        max-width: 600px;
        text-align: center;
      }
      .modal-content input {
        font-family: "Press Start 2P", cursive;
        background: #000;
        border: 1px solid #fff;
        color: #fff;
        padding: 10px;
        font-size: 1em;
        margin: 10px 0;
        width: 80%;
      }

      #leaderboard-list {
        list-style: none;
        padding: 0;
        max-height: 50vh;
        overflow-y: auto;
        text-align: left;
      }
      #leaderboard-list li {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #555;
      }
      #leaderboard-list li span:first-child {
        margin-right: 20px;
      }

      #discovery-panel {
        display: none;
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 800px;
        padding: 15px;
        background: rgba(10, 20, 40, 0.85);
        border: 2px solid #00ffff;
        color: #fff;
        text-align: center;
        z-index: 15;
        box-shadow: 0 0 15px #00ffff;
      }
      #discovery-panel h2 {
        margin-top: 0;
        font-size: 1.2em;
      }
      #discovery-panel p {
        margin: 8px 0;
        font-size: 0.8em;
        line-height: 1.4;
      }
      #discovery-close-prompt {
        margin-top: 10px;
        font-size: 0.7em;
        color: #aaa;
      }
      .rarity-Common {
        color: #ffffff;
      }
      .rarity-Rare {
        color: #55aaff;
        text-shadow: 0 0 5px #55aaff;
      }
      .rarity-Legendary {
        color: #ffd700;
        text-shadow: 0 0 8px #ffd700;
      }
      .rarity-Unique {
        background: linear-gradient(
          90deg,
          #ff0000,
          #ff7f00,
          #ffff00,
          #00ff00,
          #0000ff,
          #4b0082,
          #9400d3
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: rainbow-text 3s linear infinite;
      }
      @keyframes rainbow-text {
        0% {
          background-position: 0% 50%;
        }
        100% {
          background-position: 100% 50%;
        }
      }

      #pirate-warning {
        display: none;
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 2em;
        color: #ff0000;
        text-shadow: 3px 3px #000;
        z-index: 16;
        animation: pulse-warning 1s infinite;
      }
      @keyframes pulse-warning {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      #steal-progress-bar-container {
        display: none;
        position: absolute;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        height: 20px;
        border: 2px solid #ff0000;
        background: #330000;
        z-index: 16;
      }
      #steal-progress-bar {
        width: 0%;
        height: 100%;
        background: #ff0000;
      }

      #touch-controls {
        display: none;
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 12;
        pointer-events: none;
      }
      .touch-button {
        position: absolute;
        bottom: 30px;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.4);
        pointer-events: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        user-select: none;
      }
      .touch-button.active {
        background: rgba(255, 255, 255, 0.5);
      }
      #joystick-base {
        position: absolute;
        left: 40px;
        bottom: 40px;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.4);
        pointer-events: auto;
      }
      #joystick-knob {
        position: absolute;
        left: 30px;
        top: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
      }
      #thrust-button {
        right: 100px;
        bottom: 90px;
      }
      #turbo-button {
        right: 30px;
        bottom: 130px;
      }
      #brake-button {
        right: 30px;
        bottom: 40px;
      }
      #dock-button {
        display: none;
        right: 180px;
        bottom: 40px;
        background: rgba(0, 255, 255, 0.2);
        border-color: rgba(0, 255, 255, 0.4);
      }
      #dock-prompt {
        display: none;
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translateX(-50%);
        color: #00ffff;
        font-size: 1.5em;
        text-shadow: 2px 2px #000;
        z-index: 13;
      }
    </style>
  </head>
  <body>
    <canvas id="gameCanvas"></canvas>
    <div id="crt-overlay"></div>
    <div id="asset-cache"></div>

    <!-- Menu Screens -->
    <div id="main-menu-screen" class="game-screen">
      <h1>Super Invader</h1>
      <div>
        <button id="startButton" class="menu-button" disabled>
          Loading...
        </button>
        <button id="leaderboardButton" class="menu-button">Leaderboard</button>
      </div>
    </div>
    <div id="ship-select-screen" class="game-screen" style="display: none">
      <h2>Choose Your Ship</h2>
      <div id="ship-select-container">
        <div class="ship-card" data-ship="ship1">
          <img src="ship1.png" alt="Vanguard" />
          <p>Vanguard</p>
          <p>Life: 5/5</p>
          <p>Upgrades: 1</p>
        </div>
        <div class="ship-card" data-ship="ship2">
          <img src="ship2.png" alt="Interceptor" />
          <p>Interceptor</p>
          <p>Life: 3/3</p>
          <p>Upgrades: 2</p>
        </div>
        <div class="ship-card locked" data-ship="ship3">
          <img src="ship3.png" alt="???" />
          <p>???</p>
          <p>PREMIUM</p>
          <p>Locked</p>
        </div>
      </div>
    </div>
    <div id="game-over-screen" class="game-screen" style="display: none">
      <h1>Game Over</h1>
      <button id="restartButton" class="menu-button">Main Menu</button>
    </div>

    <!-- In-Game UI -->
    <div id="discovery-panel">
      <h2 id="discovery-name"></h2>
      <p id="discovery-formula"></p>
      <p id="discovery-description"></p>
      <p id="discovery-close-prompt">Press 'E' to close</p>
    </div>
    <div id="pirate-warning">INVASION!</div>
    <div id="steal-progress-bar-container">
      <div id="steal-progress-bar"></div>
    </div>
    <div id="dock-prompt">Press 'E' to Dock</div>

    <!-- Modals -->
    <div id="leaderboard-modal" class="modal">
      <div class="modal-content">
        <h2>Leaderboard</h2>
        <ol id="leaderboard-list"></ol>
        <button id="closeLeaderboardButton" class="menu-button">Close</button>
      </div>
    </div>
    <div id="save-score-modal" class="modal">
      <div class="modal-content">
        <h2>Docked at Station</h2>
        <p>Your current score is <span id="save-score-value">0</span>.</p>
        <input
          type="text"
          id="playerNameInput"
          placeholder="Enter Your Name"
          maxlength="10"
        />
        <button id="saveScoreButton" class="menu-button">Save Score</button>
        <button id="viewLeaderboardFromStationButton" class="menu-button">
          View Leaderboard
        </button>
        <button id="undockButton" class="menu-button">Undock</button>
      </div>
    </div>

    <!-- Touch Controls UI -->
    <div id="touch-controls">
      <div id="joystick-base">
        <div id="joystick-knob"></div>
      </div>
      <div id="thrust-button" class="touch-button">THRUST</div>
      <div id="turbo-button" class="touch-button">TURBO</div>
      <div id="brake-button" class="touch-button">BRAKE</div>
      <div id="dock-button" class="touch-button">DOCK</div>
    </div>

    <script type="module">
      // --- FIREBASE IMPORTS ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        limit,
        setLogLevel,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- SETUP ---
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const assetCache = document.getElementById("asset-cache");

      // UI Elements
      const mainMenuScreen = document.getElementById("main-menu-screen");
      const shipSelectScreen = document.getElementById("ship-select-screen");
      const gameOverScreen = document.getElementById("game-over-screen");
      const discoveryPanel = document.getElementById("discovery-panel");
      const startButton = document.getElementById("startButton");
      const restartButton = document.getElementById("restartButton");
      const shipCards = document.querySelectorAll(".ship-card");
      const pirateWarning = document.getElementById("pirate-warning");
      const stealBarContainer = document.getElementById(
        "steal-progress-bar-container"
      );
      const stealBar = document.getElementById("steal-progress-bar");
      const dockPrompt = document.getElementById("dock-prompt");
      const dockButton = document.getElementById("dock-button");
      const leaderboardModal = document.getElementById("leaderboard-modal");
      const saveScoreModal = document.getElementById("save-score-modal");
      const leaderboardButton = document.getElementById("leaderboardButton");
      const closeLeaderboardButton = document.getElementById(
        "closeLeaderboardButton"
      );
      const undockButton = document.getElementById("undockButton");
      const viewLeaderboardFromStationButton = document.getElementById(
        "viewLeaderboardFromStationButton"
      );
      const saveScoreButton = document.getElementById("saveScoreButton");

      // --- FIREBASE SETUP ---
      let db, auth;
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";

      async function initFirebase() {
        try {
          const firebaseConfigStr =
            typeof __firebase_config !== "undefined" ? __firebase_config : "{}";
          if (firebaseConfigStr === "{}") {
            console.warn("Firebase config is missing.");
            return;
          }
          const firebaseConfig = JSON.parse(firebaseConfigStr);
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
          setLogLevel("debug");

          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          ) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
          console.log(
            "Firebase initialized and user signed in.",
            auth.currentUser?.uid
          );
          setupLeaderboardListener();
        } catch (error) {
          console.error("Firebase initialization failed:", error);
        }
      }

      // --- LEADERBOARD LOGIC ---
      let leaderboardData = [];
      function setupLeaderboardListener() {
        const leaderboardCol = collection(
          db,
          `/artifacts/${appId}/public/data/leaderboard`
        );
        const q = query(leaderboardCol);

        onSnapshot(
          q,
          (snapshot) => {
            leaderboardData = [];
            snapshot.forEach((doc) => {
              leaderboardData.push(doc.data());
            });
            leaderboardData.sort((a, b) => b.score - a.score);
            updateLeaderboardUI();
          },
          (error) => {
            console.error("Error listening to leaderboard:", error);
          }
        );
      }

      function updateLeaderboardUI() {
        const list = document.getElementById("leaderboard-list");
        list.innerHTML = "";
        leaderboardData.slice(0, 20).forEach((entry, index) => {
          const li = document.createElement("li");
          li.innerHTML = `<span>${index + 1}. ${entry.name}</span><span>${
            entry.score
          }</span>`;
          list.appendChild(li);
        });
      }

      async function saveScore(name, scoreToSave) {
        if (!name || scoreToSave <= 0) return;
        try {
          const leaderboardCol = collection(
            db,
            `/artifacts/${appId}/public/data/leaderboard`
          );
          await addDoc(leaderboardCol, {
            name: name,
            score: scoreToSave,
            timestamp: new Date(),
          });
          console.log("Score saved successfully!");
          score = 0;
        } catch (error) {
          console.error("Error saving score: ", error);
        }
      }

      // ... (rest of the code is largely the same, only showing relevant parts for brevity)
      // --- ASSET LOADING, GAME STATE, PLAYER, CAMERA, GENERATION, etc. ---

      // --- DOCKING LOGIC ---
      let nearestStationInfo = { distance: Infinity };
      const DOCKING_RANGE = 200;

      function isNearStation() {
        return station && nearestStationInfo.distance < DOCKING_RANGE;
      }

      function dockAtStation() {
        if (!isNearStation()) return;
        gameState = "docked";
        document.getElementById("save-score-value").textContent = score;
        saveScoreModal.style.display = "flex";
      }

      function undock() {
        saveScoreModal.style.display = "none";
        gameState = "playing";
      }

      // --- GAME LOOP ---
      function gameLoop() {
        if (gameState === "docked") {
          requestAnimationFrame(gameLoop);
          return;
        }

        // ... (rest of the game loop)
      }

      // --- INIT ---
      initFirebase();
      // loadAllAssets(); // This should be called from within the script to ensure it runs
    </script>
  </body>
</html>
