<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Super Invader</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Make the canvas fill the entire screen */
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        font-family: "Press Start 2P", cursive;
        color: white;
      }
      canvas {
        display: none; /* Hidden until game starts */
      }

      #asset-cache {
        position: absolute;
        top: -9999px;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }

      #crt-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }
      #crt-overlay::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.4) 0px,
          rgba(0, 0, 0, 0.4) 1px,
          transparent 1px,
          transparent 2px
        );
        opacity: 0.9;
      }
      #crt-overlay::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          ellipse at center,
          rgba(0, 0, 0, 0) 50%,
          rgba(0, 0, 0, 0.85) 100%
        );
        animation: flicker 0.1s infinite;
      }
      @keyframes flicker {
        0% {
          opacity: 0.9;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.9;
        }
      }

      @keyframes scroll-background {
        from {
          background-position: 0 0;
        }
        to {
          background-position: -512px 0;
        }
      }

      .game-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        background-image: url("https://cdn.wallpapersafari.com/63/68/f1g5Ap.png");
        background-size: auto;
        animation: scroll-background 60s linear infinite;
        z-index: 20;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }

      .game-screen h1,
      .game-screen h2 {
        text-shadow: 4px 4px #00ffff;
      }
      .game-screen h1 {
        font-size: 3em;
      }
      .game-screen h2 {
        font-size: 2em;
      }

      .menu-button {
        font-family: "Press Start 2P", cursive;
        font-size: 1.5em;
        padding: 15px 30px;
        background-color: #333;
        color: white;
        border: 2px solid white;
        cursor: pointer;
        margin-top: 20px;
        text-shadow: 2px 2px #000;
      }
      .menu-button:hover {
        background-color: #00ffff;
        color: #000;
      }
      .menu-button:disabled {
        background-color: #222;
        color: #555;
        border-color: #555;
        cursor: not-allowed;
      }

      #ship-select-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .ship-card {
        border: 2px solid #888;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        background: rgba(0, 0, 0, 0.5);
      }
      .ship-card:hover {
        border-color: #00ffff;
        box-shadow: 0 0 15px #00ffff;
        transform: scale(1.05);
      }
      .ship-card img {
        width: 96px;
        height: 96px;
        image-rendering: pixelated;
      }
      .ship-card p {
        margin: 5px 0 0 0;
        font-size: 0.8em;
      }
      .ship-card.locked {
        cursor: not-allowed;
        filter: grayscale(1) brightness(0.5);
      }
      .ship-card.locked:hover {
        border-color: #888;
        box-shadow: none;
        transform: none;
      }

      .modal {
        display: none;
        position: absolute;
        z-index: 25;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: rgba(10, 20, 40, 0.9);
        border: 2px solid #00ffff;
        padding: 20px;
        width: 90%;
        max-width: 600px;
        text-align: center;
      }
      .modal-content input {
        font-family: "Press Start 2P", cursive;
        background: #000;
        border: 1px solid #fff;
        color: #fff;
        padding: 10px;
        font-size: 1em;
        margin: 10px 0;
        width: 80%;
      }

      #leaderboard-list {
        list-style: none;
        padding: 0;
        max-height: 50vh;
        overflow-y: auto;
        text-align: left;
      }
      #leaderboard-list li {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #555;
      }
      #leaderboard-list li span:first-child {
        margin-right: 20px;
      }

      #discovery-panel {
        display: none;
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 800px;
        padding: 15px;
        background: rgba(10, 20, 40, 0.85);
        border: 2px solid #00ffff;
        color: #fff;
        text-align: center;
        z-index: 15;
        box-shadow: 0 0 15px #00ffff;
      }
      #discovery-panel h2 {
        margin-top: 0;
        font-size: 1.2em;
      }
      #discovery-panel p {
        margin: 8px 0;
        font-size: 0.8em;
        line-height: 1.4;
      }
      #discovery-close-prompt {
        margin-top: 10px;
        font-size: 0.7em;
        color: #aaa;
      }
      .rarity-Common {
        color: #ffffff;
      }
      .rarity-Rare {
        color: #55aaff;
        text-shadow: 0 0 5px #55aaff;
      }
      .rarity-Legendary {
        color: #ffd700;
        text-shadow: 0 0 8px #ffd700;
      }
      .rarity-Unique {
        background: linear-gradient(
          90deg,
          #ff0000,
          #ff7f00,
          #ffff00,
          #00ff00,
          #0000ff,
          #4b0082,
          #9400d3
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: rainbow-text 3s linear infinite;
      }
      @keyframes rainbow-text {
        0% {
          background-position: 0% 50%;
        }
        100% {
          background-position: 100% 50%;
        }
      }

      #pirate-warning {
        display: none;
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 2em;
        color: #ff0000;
        text-shadow: 3px 3px #000;
        z-index: 16;
        animation: pulse-warning 1s infinite;
      }
      @keyframes pulse-warning {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      #steal-progress-bar-container {
        display: none;
        position: absolute;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        height: 20px;
        border: 2px solid #ff0000;
        background: #330000;
        z-index: 16;
      }
      #steal-progress-bar {
        width: 0%;
        height: 100%;
        background: #ff0000;
      }

      #touch-controls {
        display: none;
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 12;
        pointer-events: none;
      }
      .touch-button {
        position: absolute;
        bottom: 30px;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.4);
        pointer-events: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        user-select: none;
      }
      .touch-button.active {
        background: rgba(255, 255, 255, 0.5);
      }
      #joystick-base {
        position: absolute;
        left: 40px;
        bottom: 40px;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.4);
        pointer-events: auto;
      }
      #joystick-knob {
        position: absolute;
        left: 30px;
        top: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
      }
      #thrust-button {
        right: 100px;
        bottom: 90px;
      }
      #turbo-button {
        right: 30px;
        bottom: 130px;
      }
      #brake-button {
        right: 30px;
        bottom: 40px;
      }
      #dock-button {
        display: none;
        right: 180px;
        bottom: 40px;
        background: rgba(0, 255, 255, 0.2);
        border-color: rgba(0, 255, 255, 0.4);
      }
      #dock-prompt {
        display: none;
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translateX(-50%);
        color: #00ffff;
        font-size: 1.5em;
        text-shadow: 2px 2px #000;
        z-index: 13;
      }
    </style>
  </head>
  <body>
    <canvas id="gameCanvas"></canvas>
    <div id="crt-overlay"></div>
    <div id="asset-cache"></div>

    <!-- Menu Screens -->
    <div id="main-menu-screen" class="game-screen">
      <h1>Super Invader</h1>
      <div>
        <button id="startButton" class="menu-button" disabled>
          Loading...
        </button>
        <button id="leaderboardButton" class="menu-button">Leaderboard</button>
      </div>
    </div>
    <div id="ship-select-screen" class="game-screen" style="display: none">
      <h2>Choose Your Ship</h2>
      <div id="ship-select-container">
        <div class="ship-card" data-ship="ship1">
          <img src="ship1.png" alt="Vanguard" />
          <p>Vanguard</p>
          <p>Life: 5/5</p>
          <p>Upgrades: 1</p>
        </div>
        <div class="ship-card" data-ship="ship2">
          <img src="ship2.png" alt="Interceptor" />
          <p>Interceptor</p>
          <p>Life: 3/3</p>
          <p>Upgrades: 2</p>
        </div>
        <div class="ship-card locked" data-ship="ship3">
          <img src="ship3.png" alt="???" />
          <p>???</p>
          <p>PREMIUM</p>
          <p>Locked</p>
        </div>
      </div>
    </div>
    <div id="game-over-screen" class="game-screen" style="display: none">
      <h1>Game Over</h1>
      <button id="restartButton" class="menu-button">Main Menu</button>
    </div>

    <!-- In-Game UI -->
    <div id="discovery-panel">
      <h2 id="discovery-name"></h2>
      <p id="discovery-formula"></p>
      <p id="discovery-description"></p>
      <p id="discovery-close-prompt">Press 'E' to close</p>
    </div>
    <div id="pirate-warning">INVASION!</div>
    <div id="steal-progress-bar-container">
      <div id="steal-progress-bar"></div>
    </div>
    <div id="dock-prompt">Press 'E' to Dock</div>

    <!-- Modals -->
    <div id="leaderboard-modal" class="modal">
      <div class="modal-content">
        <h2>Leaderboard</h2>
        <ol id="leaderboard-list"></ol>
        <button id="closeLeaderboardButton" class="menu-button">Close</button>
      </div>
    </div>
    <div id="save-score-modal" class="modal">
      <div class="modal-content">
        <h2>Docked at Station</h2>
        <p>Your current score is <span id="save-score-value">0</span>.</p>
        <input
          type="text"
          id="playerNameInput"
          placeholder="Enter Your Name"
          maxlength="10"
        />
        <button id="saveScoreButton" class="menu-button">Save Score</button>
        <button id="viewLeaderboardFromStationButton" class="menu-button">
          View Leaderboard
        </button>
        <button id="undockButton" class="menu-button">Undock</button>
      </div>
    </div>

    <!-- Touch Controls UI -->
    <div id="touch-controls">
      <div id="joystick-base">
        <div id="joystick-knob"></div>
      </div>
      <div id="thrust-button" class="touch-button">THRUST</div>
      <div id="turbo-button" class="touch-button">TURBO</div>
      <div id="brake-button" class="touch-button">BRAKE</div>
      <div id="dock-button" class="touch-button">DOCK</div>
    </div>

    <script type="module">
      // --- FIREBASE IMPORTS ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        setLogLevel,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- SETUP ---
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const assetCache = document.getElementById("asset-cache");

      // UI Elements
      const mainMenuScreen = document.getElementById("main-menu-screen");
      const shipSelectScreen = document.getElementById("ship-select-screen");
      const gameOverScreen = document.getElementById("game-over-screen");
      const discoveryPanel = document.getElementById("discovery-panel");
      const startButton = document.getElementById("startButton");
      const restartButton = document.getElementById("restartButton");
      const shipCards = document.querySelectorAll(".ship-card");
      const pirateWarning = document.getElementById("pirate-warning");
      const stealBarContainer = document.getElementById(
        "steal-progress-bar-container"
      );
      const stealBar = document.getElementById("steal-progress-bar");
      const dockPrompt = document.getElementById("dock-prompt");
      const dockButton = document.getElementById("dock-button");
      const leaderboardModal = document.getElementById("leaderboard-modal");
      const saveScoreModal = document.getElementById("save-score-modal");
      const leaderboardButton = document.getElementById("leaderboardButton");
      const closeLeaderboardButton = document.getElementById(
        "closeLeaderboardButton"
      );
      const undockButton = document.getElementById("undockButton");
      const viewLeaderboardFromStationButton = document.getElementById(
        "viewLeaderboardFromStationButton"
      );
      const saveScoreButton = document.getElementById("saveScoreButton");
      const touchControls = document.getElementById("touch-controls");

      // --- FIREBASE SETUP ---
      let db, auth;

      async function initFirebase() {
        try {
          // UPDATED: Replaced placeholder with your provided config
          const firebaseConfig = {
            apiKey: "AIzaSyCFWrErGbsxkNwVMhJMyDYkpY1FO3B33Yk",
            authDomain: "superinvader-af884.firebaseapp.com",
            projectId: "superinvader-af884",
            storageBucket: "superinvader-af884.appspot.com",
            messagingSenderId: "196708489729",
            appId: "1:196708489729:web:2990c863c006cccf2e7e00",
            measurementId: "G-1VFFXP0X67",
          };

          // This logic is for a different environment, we'll use your config directly
          // const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
          // if (firebaseConfigStr === '{}') {
          //     console.warn("Firebase config is missing.");
          //     return;
          // }
          // const firebaseConfig = JSON.parse(firebaseConfigStr);

          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
          setLogLevel("debug");

          // This logic is for a different auth environment, we'll use anonymous sign-in
          // if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          //     await signInWithCustomToken(auth, __initial_auth_token);
          // } else {
          //     await signInAnonymously(auth);
          // }
          await signInAnonymously(auth);

          console.log(
            "Firebase initialized and user signed in.",
            auth.currentUser?.uid
          );
          setupLeaderboardListener();
        } catch (error) {
          console.error("Firebase initialization failed:", error);
        }
      }

      // --- LEADERBOARD LOGIC ---
      let leaderboardData = [];
      function setupLeaderboardListener() {
        if (!db) return; // Guard against missing config
        const leaderboardCol = collection(db, `leaderboard`); // Simplified path
        const q = query(leaderboardCol);

        onSnapshot(
          q,
          (snapshot) => {
            leaderboardData = [];
            snapshot.forEach((doc) => {
              leaderboardData.push(doc.data());
            });
            leaderboardData.sort((a, b) => b.score - a.score);
            updateLeaderboardUI();
          },
          (error) => {
            console.error("Error listening to leaderboard:", error);
          }
        );
      }

      function updateLeaderboardUI() {
        const list = document.getElementById("leaderboard-list");
        list.innerHTML = "";
        leaderboardData.slice(0, 20).forEach((entry, index) => {
          const li = document.createElement("li");
          li.innerHTML = `<span>${index + 1}. ${entry.name}</span><span>${
            entry.score
          }</span>`;
          list.appendChild(li);
        });
      }

      async function saveScore(name, scoreToSave) {
        if (!name || scoreToSave <= 0 || !db) return;
        try {
          const leaderboardCol = collection(db, `leaderboard`); // Simplified path
          await addDoc(leaderboardCol, {
            name: name,
            score: scoreToSave,
            timestamp: new Date(),
          });
          console.log("Score saved successfully!");
          score = 0;
        } catch (error) {
          console.error("Error saving score: ", error);
        }
      }

      // --- MINERAL & ATOM DATABASE ---
      const mineralsDB = [
        {
          name: "Quartz",
          formula: "SiO₂",
          description: "A hard, crystalline mineral composed of silica.",
          rarity: "Common",
          score: 10,
        },
        {
          name: "Iron",
          formula: "Fe",
          description:
            "The most common element on Earth by mass, forged in the cores of stars.",
          rarity: "Common",
          score: 25,
        },
        {
          name: "Gold",
          formula: "Au",
          description:
            "A precious metal forged in the collision of neutron stars.",
          rarity: "Rare",
          score: 50,
        },
        {
          name: "Diamond",
          formula: "C",
          description:
            "A metastable allotrope of carbon, formed under immense pressure deep within planetary mantles.",
          rarity: "Rare",
          score: 80,
        },
        {
          name: "Iridium",
          formula: "Ir",
          description:
            "A very hard, brittle, silvery-white transition metal. Evidence of extraterrestrial impacts.",
          rarity: "Rare",
          score: 100,
        },
        {
          name: "Tanzanite",
          formula: "Ca₂Al₃(SiO₄)(Si₂O₇)O(OH)",
          description:
            "Exhibits strong trichroism, appearing alternately blue, violet and burgundy.",
          rarity: "Legendary",
          score: 225,
        },
        {
          name: "Painite",
          formula: "CaZrAl₉O₁₅(BO₃)",
          description:
            "Once held the Guinness World Record for the rarest gemstone.",
          rarity: "Legendary",
          score: 250,
        },
        {
          name: "Jarosite",
          formula: "KFe₃(SO₄)₂(OH)₆",
          description:
            "Its discovery on Mars provided strong evidence of past water activity.",
          rarity: "Unique",
          score: 1000,
        },
        {
          name: "Helium-3",
          formula: "³He",
          description:
            "A light, non-radioactive isotope of helium, thought to be abundant on the Moon.",
          rarity: "Unique",
          score: 1500,
        },
        {
          name: "Oganesson",
          formula: "Og",
          description:
            "The heaviest element ever created, with an extremely short half-life.",
          rarity: "Unique",
          score: 5000,
        },
      ];

      // --- ASSET LOADING ---
      const shipImages = {
        ship1: new Image(),
        ship2: new Image(),
        ship3: new Image(),
      };
      const pirateImage = new Image();
      const stationImage = new Image();
      const asteroidImages = [];
      const planetSpriteSheets = [];
      const PLANET_FRAME_COUNT = 24;
      const planetSpriteSheetSources = [
        "Planet_Sprite_Sheets/1.png",
        "Planet_Sprite_Sheets/2.png",
        "Planet_Sprite_Sheets/3.png",
        "Planet_Sprite_Sheets/4.png",
        "Planet_Sprite_Sheets/5.png",
        "Planet_Sprite_Sheets/6.png",
        "Planet_Sprite_Sheets/7.png",
        "Planet_Sprite_Sheets/8.png",
      ];
      const asteroidImageSources = [
        "Asteroids/1.png",
        "Asteroids/2.png",
        "Asteroids/3.png",
        "Asteroids/4.png",
        "Asteroids/5.png",
        "Asteroids/6.png",
        "Asteroids/7.png",
        "Asteroids/8.png",
        "Asteroids/9.png",
        "Asteroids/10.png",
        "Asteroids/11.png",
        "Asteroids/12.png",
        "Asteroids/13.png",
        "Asteroids/14.png",
        "Asteroids/15.png",
      ];

      // NEW: Audio assets
      const radarAudio = new Audio("Radar.mp3");
      const loopAudio = new Audio("loop.mp3");
      const alarmAudio = new Audio("alarm.mp3");

      let assetsToLoad =
        planetSpriteSheetSources.length +
        asteroidImageSources.length +
        Object.keys(shipImages).length +
        2; // +1 pirate, +1 station
      let assetsLoaded = 0;

      function assetLoaded() {
        assetsLoaded++;
        if (assetsLoaded === assetsToLoad) {
          startButton.disabled = false;
          startButton.textContent = "Start";
        }
      }

      // --- GAME STATE ---
      let gameState = "menu";
      let score = 0;
      let nearestPlanetInfo = {
        name: "",
        distance: Infinity,
        discovered: false,
      };
      let isRadarPlaying = false;
      let isPanelOpen = false;
      let animationFrameId;
      let pendingInvasionRarity = null;
      let stealProgress = 0;
      let station = null;

      // --- PLAYER & PIRATE ---
      const player = {
        x: 0,
        y: 0,
        radius: 15,
        angle: 0,
        rotationSpeed: 0.1,
        speed: 0,
        acceleration: 0.1,
        turboAcceleration: 0.5,
        friction: 0.98,
        image: null,
        velX: 0,
        velY: 0,
      };
      const REPULSION_RANGE = 150;
      const REPULSION_STRENGTH = 0.5;

      let pirates = [];
      const PIRATE_STEAL_RANGE = 300;
      const PIRATE_INVASION_DURATION = 20 * 60;
      const PIRATE_BASE_MAX_SPEED = 7.0;
      const PIRATE_BASE_ACCELERATION = 0.1;
      const PIRATE_TURBO_MAX_SPEED = 9.5;
      const PIRATE_TURBO_ACCELERATION = 0.15;

      // --- CAMERA & GENERATION ---
      const camera = { x: player.x, y: player.y };
      let stars = [];
      const starLayers = [
        { speed: 0.2, radius: 0.5, countMultiplier: 0.5 },
        { speed: 0.4, radius: 1.0, countMultiplier: 0.35 },
        { speed: 0.6, radius: 1.2, countMultiplier: 0.15 },
      ];
      let planets = [];
      let asteroids = [];
      const SECTOR_SIZE = 5000;
      let generatedSectors = new Set();

      function mulberry32(a) {
        return function () {
          var t = (a += 0x6d2b79f5);
          t = Math.imul(t ^ (t >>> 15), t | 1);
          t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
          return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
      }

      function generateEntitiesForSector(sectorX, sectorY) {
        const sectorKey = `${sectorX},${sectorY}`;
        if (generatedSectors.has(sectorKey)) return;
        generatedSectors.add(sectorKey);

        const seed = sectorX * 18397 + sectorY * 23117;
        const rng = mulberry32(seed);

        let hasPlanet = false;
        if (rng() < 0.25) {
          hasPlanet = true;
          const pScale = 3.0,
            pSheet =
              planetSpriteSheets[Math.floor(rng() * planetSpriteSheets.length)],
            frameWidth = pSheet.width / PLANET_FRAME_COUNT,
            w = frameWidth * pScale,
            h = pSheet.height * pScale,
            mineral = mineralsDB[Math.floor(rng() * mineralsDB.length)];
          planets.push({
            x: sectorX * SECTOR_SIZE + rng() * SECTOR_SIZE,
            y: sectorY * SECTOR_SIZE + rng() * SECTOR_SIZE,
            radius: w / 2,
            sheet: pSheet,
            discovered: false,
            width: w,
            height: h,
            frameCount: PLANET_FRAME_COUNT,
            frameWidth: frameWidth,
            currentFrame: 0,
            animationTimer: 0,
            animationSpeed: 20 + rng() * 15,
            mineral: mineral,
          });
        }

        if (rng() < 0.4) {
          const numAsteroids = Math.floor(rng() * 25) + 10;
          for (let i = 0; i < numAsteroids; i++) {
            const aImg =
              asteroidImages[Math.floor(rng() * asteroidImages.length)];
            asteroids.push({
              x: sectorX * SECTOR_SIZE + rng() * SECTOR_SIZE,
              y: sectorY * SECTOR_SIZE + rng() * SECTOR_SIZE,
              image: aImg,
              radius: aImg.width / 2,
              angle: rng() * Math.PI * 2,
              rotationSpeed: (rng() - 0.5) * 0.02,
              speedX: (rng() - 0.5) * 2,
              speedY: (rng() - 0.5) * 2,
            });
          }
        }

        if (!hasPlanet && rng() < 0.03) {
          // ~3% chance for station in empty sectors
          station = {
            x: sectorX * SECTOR_SIZE + rng() * SECTOR_SIZE,
            y: sectorY * SECTOR_SIZE + rng() * SECTOR_SIZE,
            radius: 100,
          };
        }
      }

      // --- PIRATE MECHANICS ---
      function spawnPirate() {
        // ... (pirate logic is unchanged)
      }

      function updatePirates() {
        // ... (pirate logic is unchanged)
      }

      // --- INPUT & EVENT LISTENERS ---
      const keys = {
        ArrowUp: false,
        ArrowLeft: false,
        ArrowRight: false,
        Shift: false,
        " ": false,
        e: false,
      };
      window.addEventListener("keydown", (e) => {
        if (keys.hasOwnProperty(e.key)) {
          e.preventDefault();
          keys[e.key] = true;
        }
        if (e.key === "e" || e.key === "E") {
          if (isPanelOpen) {
            toggleDiscoveryPanel(false);
          } else if (isNearStation()) {
            dockAtStation();
          }
        }
      });
      window.addEventListener("keyup", (e) => {
        if (keys.hasOwnProperty(e.key)) {
          keys[e.key] = false;
        }
      });

      startButton.addEventListener("click", () => {
        loopAudio.play().catch(() => {});
        loopAudio.pause();
        alarmAudio.play().catch(() => {});
        alarmAudio.pause();
        radarAudio.play().catch(() => {});
        radarAudio.pause();

        mainMenuScreen.style.display = "none";
        shipSelectScreen.style.display = "flex";
        gameState = "shipSelect";
      });
      restartButton.addEventListener("click", () => {
        gameOverScreen.style.display = "none";
        mainMenuScreen.style.display = "flex";
        gameState = "menu";
        loopAudio.pause();
        loopAudio.currentTime = 0;
      });

      shipCards.forEach((card) => {
        if (card.classList.contains("locked")) return;
        card.addEventListener("click", () => {
          const shipId = card.getAttribute("data-ship");
          startGame(shipId);
        });
      });

      discoveryPanel.addEventListener("click", () =>
        toggleDiscoveryPanel(false)
      );

      // MODAL BUTTONS
      leaderboardButton.addEventListener(
        "click",
        () => (leaderboardModal.style.display = "flex")
      );
      closeLeaderboardButton.addEventListener(
        "click",
        () => (leaderboardModal.style.display = "none")
      );
      undockButton.addEventListener("click", undock);
      viewLeaderboardFromStationButton.addEventListener(
        "click",
        () => (leaderboardModal.style.display = "flex")
      );
      saveScoreButton.addEventListener("click", () => {
        const playerName = document
          .getElementById("playerNameInput")
          .value.trim();
        if (playerName) {
          saveScore(playerName, score);
          document.getElementById("playerNameInput").value = "";
          undock();
        } else {
          alert("Please enter a name."); // A simple alert is fine for this modal
        }
      });
      dockButton.addEventListener("click", dockAtStation);

      function startGame(shipId) {
        // ... (startGame logic unchanged)
      }

      function resetGameData() {
        // ... (resetGameData logic unchanged)
        station = null;
      }

      function toggleDiscoveryPanel(show, mineral = null) {
        // ... (toggleDiscoveryPanel logic unchanged)
      }

      function triggerPendingInvasion() {
        // ... (triggerPendingInvasion logic unchanged)
      }

      function generateStars() {
        // ... (generateStars logic unchanged)
      }
      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        generateStars();
      }
      window.addEventListener("resize", resizeCanvas);

      // --- GAME LOOP ---
      function gameLoop() {
        if (gameState === "docked") {
          requestAnimationFrame(gameLoop);
          return;
        }

        // ... (rest of the game loop logic is unchanged)
      }

      // --- TOUCH CONTROLS SETUP ---
      function setupTouchControls() {
        // ... (touch controls logic is unchanged)
      }

      // --- START THE GAME (Asset Loading) ---
      function loadAllAssets() {
        resizeCanvas();

        const setupImageLoader = (img, src) => {
          img.onload = assetLoaded;
          img.onerror = () => {
            console.error(`Failed to load asset: ${src}`);
          };
          img.src = src;
          assetCache.appendChild(img);
        };

        setupImageLoader(shipImages.ship1, "ship1.png");
        setupImageLoader(shipImages.ship2, "ship2.png");
        setupImageLoader(shipImages.ship3, "ship3.png");
        setupImageLoader(pirateImage, "Pirate.png");
        setupImageLoader(
          stationImage,
          "https://placehold.co/128x128/3333ff/FFFFFF?text=Station"
        );

        asteroidImageSources.forEach((src) => {
          const i = new Image();
          asteroidImages.push(i);
          setupImageLoader(i, src);
        });

        planetSpriteSheetSources.forEach((src) => {
          const i = new Image();
          planetSpriteSheets.push(i);
          setupImageLoader(i, src);
        });

        setupTouchControls(); // Initialize touch controls
      }

      // --- INITIALIZE ---
      initFirebase();
      loadAllAssets();
    </script>
  </body>
</html>
